name: Images

on:
  pull_request:
    paths:
      - 'images/**'
      - 'docker-bake.hcl'
      - '.github/workflows/images.yml'
  push:
    branches:
      - master
    paths:
      - 'images/**'
      - 'docker-bake.hcl'
      - '.github/workflows/images.yml'
    tags:
      - 'images/base/v*'

env:
  REGISTRY: ghcr.io

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile:
          - images/base/Dockerfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}

  # Determine which images to build based on trigger
  prepare:
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.variants.outputs.variants }}
      is_release: ${{ steps.variants.outputs.is_release }}
      version: ${{ steps.variants.outputs.version }}
    steps:
      - name: Determine build variants
        id: variants
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Extract variant and version from tag: images/base/v1.0.0 â†’ base, v1.0.0
            TAG="${GITHUB_REF_NAME}"
            VARIANT=$(echo "$TAG" | cut -d'/' -f2)
            VERSION=$(echo "$TAG" | cut -d'/' -f3)
            echo "variants=[\"$VARIANT\"]" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building $VARIANT with version $VERSION"
          else
            # Build all variants on push to master or PR
            echo 'variants=["base"]' >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "Building all variants with latest tag"
          fi

  build:
    needs: [lint, prepare]
    runs-on: warp-ubuntu-latest-x64-4x
    permissions:
      actions: read
      contents: write
      packages: write
      id-token: write
    strategy:
      matrix:
        variant: ${{ fromJson(needs.prepare.outputs.variants) }}
    outputs:
      base-digest: ${{ steps.digest.outputs.base }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set image name
        id: image
        run: echo "name=${GITHUB_REPOSITORY_OWNER,,}/headjack" >> $GITHUB_OUTPUT

      - name: Configure WarpBuild Docker Builder
        uses: WarpBuilds/docker-configure@157b8a388c103b2261932b838d8ea60f6fa0a7df # v1
        with:
          profile-name: default

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image with Bake
        id: bake
        uses: docker/bake-action@4ba453fbc2db7735392b93edf935aaf9b1e8f747 # v6
        with:
          files: docker-bake.hcl
          targets: ${{ matrix.variant }}
          push: ${{ github.event_name != 'pull_request' }}
          set: |
            *.platform=${{ github.event_name != 'pull_request' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
            ${{ matrix.variant }}.tags=${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ matrix.variant }}
            ${{ matrix.variant }}.tags=${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ matrix.variant }}-${{ needs.prepare.outputs.version }}

      - name: Extract digest
        if: github.event_name != 'pull_request'
        id: digest
        run: |
          DIGEST=$(echo '${{ steps.bake.outputs.metadata }}' | jq -r '."${{ matrix.variant }}"."containerimage.digest"')
          echo "${{ matrix.variant }}=$DIGEST" >> $GITHUB_OUTPUT

  sign:
    needs: [prepare, build]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write
    strategy:
      matrix:
        variant: ${{ fromJson(needs.prepare.outputs.variants) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set image name
        id: image
        run: echo "name=${GITHUB_REPOSITORY_OWNER,,}/headjack" >> $GITHUB_OUTPUT

      - name: Get digest
        id: digest
        run: |
          # Get the digest from the build job output
          echo "value=${{ needs.build.outputs.base-digest }}" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          image: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}@${{ steps.digest.outputs.value }}
          format: spdx-json
          output-file: sbom-${{ matrix.variant }}.spdx.json
          artifact-name: ${{ matrix.variant }}-image.spdx.json
          upload-release-assets: false

      - name: Install Cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Sign image with Cosign
        env:
          COSIGN_YES: "true"
        run: cosign sign ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}@${{ steps.digest.outputs.value }}

      - name: Attest SBOM with Cosign
        env:
          COSIGN_YES: "true"
        run: cosign attest --predicate sbom-${{ matrix.variant }}.spdx.json --type spdxjson ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}@${{ steps.digest.outputs.value }}
